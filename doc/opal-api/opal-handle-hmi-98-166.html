
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hypervisor Maintenance Interrupt (HMI) &#8212; skiboot v6.2-rc1
 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OPAL_HANDLE_INTERRUPT" href="opal-handle-interrupt.html" />
    <link rel="prev" title="OPAL_GET_XIVE_SOURCE" href="opal-get-xive-source-38.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="opal-handle-interrupt.html" title="OPAL_HANDLE_INTERRUPT"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="opal-get-xive-source-38.html" title="OPAL_GET_XIVE_SOURCE"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skiboot v6.2-rc1
 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">OPAL API Documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="hypervisor-maintenance-interrupt-hmi">
<h1>Hypervisor Maintenance Interrupt (HMI)<a class="headerlink" href="#hypervisor-maintenance-interrupt-hmi" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Hypervisor Maintenance Interrupt usually reports error related to processor
recovery/checkstop, NX/NPU checkstop and Timer facility. Hypervisor then
takes this opportunity to analyze and recover from some of these errors.
Hypervisor takes assistance from OPAL layer to handle and recover from HMI.
After handling HMI, OPAL layer sends the summary of error report and status
of recovery action using HMI event. See ref: <cite>opal-messages.rst</cite> for HMI
event structure under <code class="docutils literal notranslate"><span class="pre">`OPAL_MSG_HMI_EVT`</span></code> section.</p>
<p>HMI is thread specific. The reason for HMI is available in a per thread
Hypervisor Maintenance Exception Register (HMER). A Hypervisor Maintenance
Exception Enable Register (HMEER) is per core. Bits from the HMER need to
be enabled by the corresponding bits in the HMEER in order to cause an HMI.</p>
<p>Several interrupt reasons are routed in parallel to each of the thread
specific copies. Each thread can only clear bits in its own HMER. OPAL
handler from each thread clears the respective bit from HMER register
after handling the error.</p>
</div></blockquote>
</div>
<div class="section" id="list-of-errors-that-causes-hmi">
<h1>List of errors that causes HMI<a class="headerlink" href="#list-of-errors-that-causes-hmi" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ul class="simple">
<li>CPU Errors</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Processor Core checkstop</li>
<li>Processor retry recovery</li>
<li>NX/NPU/CAPP checkstop.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Timer facility Errors</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>ChipTOD Errors</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>ChipTOD sync check and parity errors</li>
<li>ChipTOD configuration register parity errors</li>
<li>ChiTOD topology failover</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Timebase (TB) errors</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>TB parity/residue error</li>
<li>TFMR parity and firmware control error</li>
<li>DEC/HDEC/PURR/SPURR parity errors</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="hmi-handling">
<h1>HMI handling<a class="headerlink" href="#hmi-handling" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>A core/NX/NPU checkstops are reported as malfunction alert (HMER bit 0).
OPAL handler scans through Fault Isolation Register (FIR) for each
core/nx/npu to detect the exact reason for checkstop and reports it back
to the host alongwith the disposition.</p>
<p>A processor recovery is reported through HMER bits 2, 3 and 11. These are
just an informational messages and no extra recovery is required.</p>
<p>Timer facility errors are reported through HMER bit 4. These are all
recoverable errors. The exact reason for the errors are stored in
Timer Facility Management Register (TFMR). Some of the Timer facility
errors affects TB and some of them affects TOD. TOD is a per chip
Time-Of-Day logic that holds the actual time value of the chip and
communicates with every TOD in the system to achieve synchronized
timer value within a system. TB is per core register (64-bit) derives its
value from ChipTOD at startup and then it gets periodically incremented
by STEP signal provided by the TOD. In a multi-socket system TODs are
always configured as master/backup TOD under primary/secondary
topology configuration respectively.</p>
<p>TB error generates HMI on all threads of the affected core. TB errors
except DEC/HDEC/PURR/SPURR parity errors, causes TB to stop running
making it invalid. As part of TB recovery, OPAL hmi handler synchronizes
with all threads, clears the TB errors and then re-sync the TB with TOD
value putting it back in running state.</p>
<p>TOD errors generates HMI on every core/thread of affected chip. The reason
for TOD errors are stored in TOD ERROR register (0x40030). As part of the
recovery OPAL hmi handler clears the TOD error and then requests new TOD
value from another running chipTOD in the system. Sometimes, if a primary
chipTOD is in error, it may need a TOD topology switch to recover from
error. A TOD topology switch basically makes a backup as new active master.</p>
</div></blockquote>
</div>
<div class="section" id="opal-handle-hmi-and-opal-handle-hmi2">
<h1>OPAL_HANDLE_HMI and OPAL_HANDLE_HMI2<a class="headerlink" href="#opal-handle-hmi-and-opal-handle-hmi2" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define OPAL_HANDLE_HMI      98</span>
<span class="c1">#define OPAL_HANDLE_HMI2     166</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OPAL_HANDLE_HMI</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">OPAL_HANDLE_HMI2</span></code></dt>
<dd>When OS host gets an Hypervisor Maintenance Interrupt (HMI), it must call
<code class="docutils literal notranslate"><span class="pre">`OPAL_HANDLE_HMI`</span></code> or <code class="docutils literal notranslate"><span class="pre">`OPAL_HANDLE_HMI2`</span></code>. The <code class="docutils literal notranslate"><span class="pre">`OPAL_HANDLE_HMI`</span></code>
is an old interface. <code class="docutils literal notranslate"><span class="pre">`OPAL_HANDLE_HMI2`</span></code> is newly introduced opal call
that returns direct info to Linux. It returns a 64-bit flag mask currently
set to provide info about which timer facilities were lost, and whether an
event was generated.</dd>
</dl>
<div class="section" id="opal-handle-hmi">
<h2>OPAL_HANDLE_HMI<a class="headerlink" href="#opal-handle-hmi" title="Permalink to this headline">¶</a></h2>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">int64_t</span> <span class="n">opal_handle_hmi</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="opal-handle-hmi2">
<h2>OPAL_HANDLE_HMI2<a class="headerlink" href="#opal-handle-hmi2" title="Permalink to this headline">¶</a></h2>
<p>Syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">int64_t</span> <span class="n">opal_handle_hmi2</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="n">out_flags</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="parameters">
<h3>parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">__be64</span> <span class="pre">*out_flags</span></code></p>
<p>Returns the 64-bit flag mask that provides info about which timer facilities
were lost, and whether an event was generated.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">OPAL_HANDLE_HMI2</span> <span class="n">out_flags</span> <span class="o">*/</span>
<span class="n">enum</span> <span class="p">{</span>
     <span class="n">OPAL_HMI_FLAGS_TB_RESYNC</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">ull</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="o">/*</span> <span class="n">Timebase</span> <span class="n">has</span> <span class="n">been</span> <span class="n">resynced</span> <span class="o">*/</span>
     <span class="n">OPAL_HMI_FLAGS_DEC_LOST</span>         <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">ull</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="o">/*</span> <span class="n">DEC</span> <span class="n">lost</span><span class="p">,</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reprogrammed</span> <span class="o">*/</span>
     <span class="n">OPAL_HMI_FLAGS_HDEC_LOST</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">ull</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="o">/*</span> <span class="n">HDEC</span> <span class="n">lost</span><span class="p">,</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reprogrammed</span> <span class="o">*/</span>
     <span class="n">OPAL_HMI_FLAGS_NEW_EVENT</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">ull</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">),</span> <span class="o">/*</span> <span class="n">An</span> <span class="n">event</span> <span class="n">has</span> <span class="n">been</span> <span class="n">created</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Hypervisor Maintenance Interrupt (HMI)</a></li>
<li><a class="reference internal" href="#list-of-errors-that-causes-hmi">List of errors that causes HMI</a></li>
<li><a class="reference internal" href="#hmi-handling">HMI handling</a></li>
<li><a class="reference internal" href="#opal-handle-hmi-and-opal-handle-hmi2">OPAL_HANDLE_HMI and OPAL_HANDLE_HMI2</a><ul>
<li><a class="reference internal" href="#opal-handle-hmi">OPAL_HANDLE_HMI</a></li>
<li><a class="reference internal" href="#opal-handle-hmi2">OPAL_HANDLE_HMI2</a><ul>
<li><a class="reference internal" href="#parameters">parameters</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="opal-get-xive-source-38.html"
                        title="previous chapter">OPAL_GET_XIVE_SOURCE</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="opal-handle-interrupt.html"
                        title="next chapter">OPAL_HANDLE_INTERRUPT</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/opal-api/opal-handle-hmi-98-166.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="opal-handle-interrupt.html" title="OPAL_HANDLE_INTERRUPT"
             >next</a> |</li>
        <li class="right" >
          <a href="opal-get-xive-source-38.html" title="OPAL_GET_XIVE_SOURCE"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skiboot v6.2-rc1
 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >OPAL API Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, IBM, others.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>